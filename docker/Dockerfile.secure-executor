# Secure Executor Container for HokiPoki
# Zero-knowledge execution environment
# Runs on PROVIDER'S machine, pulls code from requester's git

# Single stage: Use pre-compiled JS files from npm distribution
FROM node:20-alpine

# Install git, cryptsetup for encryption, e2fsprogs for mkfs.ext4, strace, and build dependencies
RUN apk add --no-cache git cryptsetup e2fsprogs strace python3 make g++ && \
    # Install Claude Code CLI globally
    npm install -g @anthropic-ai/claude-code && \
    # Install OpenAI Codex CLI globally
    npm install -g @openai/codex && \
    # Install Google Gemini CLI globally
    npm install -g @google/gemini-cli && \
    # Clean up build dependencies to reduce image size
    apk del python3 make g++ && \
    # Remove ONLY apk binaries (not libs - they're needed by installed packages)
    rm -rf /sbin/apk /etc/apk /usr/share/apk
    # IMPORTANT: Keep /lib/apk - it contains package database needed for shared libs

# Copy pre-compiled executor and dependencies (from dist/ folder)
COPY container/executor.js /app/container/executor.js
COPY config/cli-tools.js /app/config/cli-tools.js

# Create workspace (node user already exists with UID 1000)
RUN mkdir -p /workspace && \
    chown node:node /workspace && \
    chmod 700 /workspace

# SECURITY: Bash and tools are kept for AI CLI capabilities
# Code protection now relies on encrypted workspace (LUKS)
# Provider can docker exec but will only see encrypted blob

# Run as root for cryptsetup/mount operations
# Executor will drop privileges where appropriate
USER root

# Working directory
WORKDIR /app

# Entry point - only way to run commands
ENTRYPOINT ["node", "/app/container/executor.js"]

# Health check disabled (security)
HEALTHCHECK NONE

# No exposed ports (no network services)
# Container only makes outbound connections to git